name: C++ Continuous Integration (Multi-OS/Compiler)

# Triggers for this workflow:
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  # Allows manual execution from the GitHub Actions tab
  workflow_dispatch:

# Define the build jobs
jobs:
  static_analysis:
    name: "Static Analysis"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Install static analysis tools
      - name: Install Tools
        run: sudo apt-get update && sudo apt-get install -y cppcheck clang-tidy cmake

      - name: Run Cppcheck
        # Cppcheck does a quick check for basic C++ errors
        # Am corectat sintaxa: -o este folosit în loc de --xml-file
        run: cppcheck --enable=all --xml -o cppcheck.xml .

      # ATENȚIE: Clang-Tidy este dezactivat temporar.
      # Trebuie reactivat după ce build_matrix trece.
      # - name: Run Clang-Tidy
      #   # Clang-Tidy is an advanced static analyzer
      #   # Requires a build configuration (e.g., generated by CMake)
      #   run: |
      #     mkdir build
      #     cmake -S . -B build -G "Ninja"
      #     # Run clang-tidy on the whole project
      #     clang-tidy -p build $(find . -name "*.cpp" -o -name "*.cxx")

  build_matrix:
    name: Build & Test (${{ matrix.config.name }})
    # Nu depinde de static_analysis in mod strict, pentru a permite rularea chiar daca analiza esueaza

    # Configuration matrix for different environments
    strategy:
      fail-fast: false
      matrix:
        config:
          # 1. Linux (GCC) - Standard
          - name: "Ubuntu-GCC"
            os: ubuntu-latest
            cc: gcc
            cxx: g++
            generator: "Ninja"
          # 2. Linux (Clang) - Alternative Compiler
          - name: "Ubuntu-Clang"
            os: ubuntu-latest
            cc: clang
            cxx: clang++
            generator: "Ninja"
          # 3. macOS (Apple Clang)
          - name: "macOS-Clang"
            os: macos-latest
            cc: clang
            cxx: clang++
            generator: "Ninja"
          # 4. Windows (MSVC) - Microsoft Compiler
          - name: "Windows-MSVC"
            os: windows-latest
            cc: cl
            cxx: cl
            generator: "Visual Studio 17 2022" # MSVC needs a VS generator

    runs-on: ${{ matrix.config.os }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: true

      # --- Setup (Install Ninja on Linux/macOS) ---
      - name: Install Ninja (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          if [ "${{ runner.os }}" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y ninja-build
          elif [ "${{ runner.os }}" == "macOS" ]; then
            # Use Homebrew on macOS
            # Brew este adesea deja instalat
            brew install ninja || true # Folosim '|| true' ca fallback in caz ca e deja instalat
          fi

      # --- Configure (CMake) ---
      - name: Configure CMake
        run: |
          # Use the defined generator (Ninja or Visual Studio)
          cmake -S . -B ${{github.workspace}}/build -G "${{ matrix.config.generator }}" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=${{ matrix.config.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.config.cxx }}

      # --- Build (Compilation) ---
      - name: Build Project
        run: cmake --build ${{github.workspace}}/build --config Release

      # --- Debugging Step for Compilation Errors (Linux only) ---
      - name: Debug Ninja Build Log
        if: ${{ runner.os == 'Linux' && failure() }}
        run: |
          echo "==== EROARE DE COMPILARE CLARIFICATĂ (Linux/Ninja) ===="
          # Ninja ar trebui să afișeze eroarea direct în consolă, dar în caz de eșec
          # vom încerca să găsim log-ul de erori
          find ${{github.workspace}}/build -name "*.log" -exec cat {} +
          echo "======================================================="

      # --- Test (CTEST) ---
      - name: Run Tests (if CTest is used)
        # Assumes tests are defined in CMakeLists.txt using 'enable_testing()' and 'add_test()'
        working-directory: ${{github.workspace}}/build
        run: ctest --output-on-failure

      # --- Upload Artifact (Save the executable) ---
      - name: Upload Executable Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Executable-${{ matrix.config.name }}
          # Path logic to find the executable named 'MyProject'
          path: ${{ github.workspace }}/build/${{ runner.os == 'Windows' && 'Release/' || '' }}MyProject${{ runner.os == 'Windows' && '.exe' || '' }}
          # !!! REPLACE 'MyProject' with the actual name of your executable
