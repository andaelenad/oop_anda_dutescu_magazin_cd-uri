name: C++ CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  BUILD_TYPE: Debug
  EXECUTABLE_NAME: "magazin_cd"
  BIN_DIR: "bin"
  BUILD_DIR: "build"
  ARTIFACTS_DIR: "artifacts"

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        compiler: [gcc, clang, cl] # cl pentru Windows MSVC
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        if: matrix.os != 'windows-latest'
        run: sudo apt-get update && sudo apt-get install -y g++ cmake ninja-build
      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install cmake ninja

      - name: Configure CMake
        run: |
          mkdir -p $BUILD_DIR
          cd $BUILD_DIR
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cmake -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=$BUILD_TYPE ..
          else
            cmake -G Ninja -DCMAKE_BUILD_TYPE=$BUILD_TYPE ..
          fi
        shell: bash

      - name: Build
        run: |
          cd $BUILD_DIR
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cmake --build . --config $BUILD_TYPE
          else
            cmake --build .
          fi
        shell: bash

      - name: Install artifacts
        run: |
          cd $BUILD_DIR
          mkdir -p ../$ARTIFACTS_DIR
          cmake --install . --prefix ../$ARTIFACTS_DIR
        shell: bash

      - name: Move artifacts to final folder
        run: |
          FINAL_DIR="${{ matrix.os }}_${BUILD_TYPE}"
          mkdir -p "$FINAL_DIR"
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            mv ../$ARTIFACTS_DIR/bin/* "$FINAL_DIR/" || echo "No files to move"
          else
            mv ../$ARTIFACTS_DIR/bin/* "$FINAL_DIR/" || echo "No files to move"
          fi
          ls -la "$FINAL_DIR"
        shell: bash

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}_${{ env.BUILD_TYPE }}
          path: ${{ matrix.os }}_${{ env.BUILD_TYPE }}
          retention-days: 30
